<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Environment Control Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --muted: #cbd5e1;
            --accent: #22d3ee;
            --accent-2: #a855f7;
            --danger: #f87171;
            --success: #34d399;
            --border: rgba(255, 255, 255, 0.06);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.07), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(168,85,247,0.06), transparent 25%),
                        var(--bg);
            color: #e2e8f0;
            min-height: 100vh;
        }
        a { color: var(--accent); text-decoration: none; }
        .shell {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px 60px;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
        }
        .title {
            font-weight: 700;
            font-size: 32px;
            letter-spacing: -0.02em;
        }
        .subtitle { color: var(--muted); }
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35);
        }
        .grid {
            display: grid;
            gap: 16px;
        }
        .grid.two { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        input, button, select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.02);
            color: #e2e8f0;
            font-size: 14px;
        }
        input::placeholder { color: #94a3b8; }
        button {
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }
        .btn-primary { background: linear-gradient(120deg, var(--accent), var(--accent-2)); border: none; color: #0b1224; }
        .btn-secondary { background: rgba(255,255,255,0.04); }
        .btn-danger { background: rgba(248,113,113,0.12); border-color: rgba(248,113,113,0.4); color: #fecdd3; }
        .btn-ghost { background: transparent; border-color: var(--border); }
        button:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        .muted { color: var(--muted); font-size: 13px; }
        .device-card {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 14px;
            background: rgba(255,255,255,0.02);
        }
        .device-meta { display: flex; justify-content: space-between; align-items: center; }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid var(--border);
            color: var(--muted);
        }
        .pill.online { border-color: rgba(52,211,153,0.5); color: #a7f3d0; }
        .pill.offline { border-color: rgba(148,163,184,0.4); color: #cbd5e1; }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        .table th, .table td { padding: 10px 8px; border-bottom: 1px solid var(--border); text-align: left; }
        .table th { font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; color: #94a3b8; }
        .empty { color: #94a3b8; text-align: center; padding: 14px 0; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 8px; background: rgba(34,211,238,0.15); color: #67e8f9; font-size: 12px; }
        .layout { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="shell">
    <header>
        <div>
            <div class="title">Environment Control</div>
            <div class="subtitle">Minimalist dashboard to manage and visualize your devices.</div>
        </div>
        <a href="/" class="pill">â†» Refresh</a>
    </header>

    <div class="grid two">
        <div class="panel">
            <h2 style="margin-top:0; margin-bottom:12px;">Register device</h2>
            <p class="muted" style="margin-top:0;">Create a device and immediately jump to its data.</p>
            <form method="post" action="/admin/devices" class="grid" style="gap:12px;">
                <div class="form-row">
                    <input name="deviceId" placeholder="Device ID" required>
                    <input name="secret" placeholder="Shared secret" required>
                </div>
                <div class="form-row">
                    <input name="name" placeholder="Friendly name" required>
                    <input name="endpointUrl" placeholder="Device endpoint (optional)" title="Endpoint to poll data directly from the device">
                </div>
                <div>
                    <button class="btn-primary" type="submit">Save device</button>
                </div>
            </form>
            <p class="muted" style="margin-top:8px;">Use deviceId/secret in the Arduino sketch to obtain a JWT.</p>
        </div>

        <div class="panel">
            <div class="device-meta" style="margin-bottom: 12px;">
                <div>
                    <h2 style="margin:0;">Devices</h2>
                    <p class="muted" style="margin:4px 0 0 0;" th:text="${#lists.size(devices)} + ' registered'">0 registered</p>
                </div>
                <span class="badge" th:if="${selectedDevice != null}" th:text="${'Viewing ' + selectedDevice.deviceId}"></span>
            </div>
            <div class="grid" style="gap:12px;" th:if="${#lists.size(devices) > 0}">
                <div class="device-card" th:each="device : ${devices}">
                    <div class="device-meta">
                        <div>
                            <div style="font-weight:600;" th:text="${device.name}"></div>
                            <div class="muted" th:text="${device.deviceId}"></div>
                        </div>
                        <span class="pill" th:classappend="${device.lastSeen != null && device.lastSeen.isAfter(T(java.time.Instant).now().minusSeconds(120))} ? ' online' : ' offline'"
                              th:text="${device.lastSeen != null && device.lastSeen.isAfter(T(java.time.Instant).now().minusSeconds(120))} ? 'Online' : 'Offline'"></span>
                    </div>
                    <div class="muted" th:if="${device.lastSeen != null}" th:text="${'Seen ' + device.lastSeen}"></div>
                    <div class="muted">Upload status: <span th:text="${device.uploadRequested} ? 'Requested' : 'Idle'"></span></div>
                    <div class="actions">
                        <a class="pill" th:href="@{'/?selected=' + ${device.deviceId}}">View data</a>
                        <a class="pill" th:href="@{'/admin/devices/' + ${device.deviceId} + '/charts'}" target="_blank" rel="noopener">Open charts</a>
                        <form th:action="@{'/admin/devices/' + ${device.deviceId} + '/analysis'}" method="get" target="_blank">
                            <button class="btn-secondary" type="submit">ChatGPT summary</button>
                        </form>
                        <form th:action="@{'/admin/devices/' + ${device.deviceId} + '/refresh'}" method="post">
                            <button class="btn-secondary" type="submit">Sync now</button>
                        </form>
                        <form th:action="@{'/admin/devices/' + ${device.deviceId} + '/request-upload'}" method="post">
                            <button class="btn-secondary" type="submit">Trigger upload</button>
                        </form>
                        <form th:action="@{'/admin/devices/' + ${device.deviceId} + '/clear-upload'}" method="post">
                            <button class="btn-ghost" type="submit">Clear flag</button>
                        </form>
                        <form th:action="@{'/admin/devices/' + ${device.deviceId} + '/delete'}" method="post" onsubmit="return confirm('Delete device?');">
                            <button class="btn-danger" type="submit">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
            <p class="empty" th:unless="${#lists.size(devices) > 0}">No devices yet. Add one to get started.</p>
        </div>
    </div>

    <div class="panel" style="margin-top:16px;" th:if="${selectedDevice != null}">
        <div class="device-meta" style="margin-bottom: 8px;">
            <div>
                <h3 style="margin:0;" th:text="${selectedDevice.name}"></h3>
                <p class="muted" style="margin:2px 0 0 0;" th:text="${selectedDevice.deviceId}"></p>
            </div>
            <a class="pill" th:href="@{'/admin/devices/' + ${selectedDevice.deviceId} + '/charts'}" target="_blank" rel="noopener">Open charts</a>
        </div>
        <div class="muted" style="margin-bottom:10px;">
            <span><strong>Endpoint:</strong> <span th:text="${selectedDevice.endpointUrl}"></span></span>
            <span style="margin-left:16px;"><strong>Last ack:</strong> <span th:text="${selectedDevice.lastSequenceAcknowledged}"></span></span>
            <span style="margin-left:16px;"><strong>Stored records:</strong> <span th:text="${#lists.size(data)}"></span></span>
        </div>
        <div class="panel" style="background: rgba(255,255,255,0.02);">
            <table class="table" aria-label="Device data table">
                <thead><tr><th>Sequence</th><th>Payload</th><th>Timestamp</th></tr></thead>
                <tbody>
                <tr th:each="row : ${data}">
                    <td th:text="${row.sequenceNumber}"></td>
                    <td th:text="${row.payload}"></td>
                    <td th:text="${row.createdAt}"></td>
                </tr>
                </tbody>
            </table>
            <p class="empty" th:if="${#lists.isEmpty(data)}">No stored data for this device yet.</p>
        </div>
    </div>

    <div class="panel" style="margin-top:16px; text-align:center;" th:unless="${selectedDevice != null}">
        <p class="muted">Select a device to view stored data and status.</p>
    </div>
</div>
</body>
</html>
